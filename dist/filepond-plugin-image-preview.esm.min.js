/*
 * FilePondPluginImagePreview 1.0.9
 * Licensed under MIT, https://opensource.org/licenses/MIT
 * Please visit https://pqina.nl/filepond for details.
 */
const isPreviewableImage=e=>/^image/.test(e.type)&&!/svg/.test(e.type),transforms={1:()=>[1,0,0,1,0,0],2:e=>[-1,0,0,1,e,0],3:(e,t)=>[-1,0,0,-1,e,t],4:(e,t)=>[1,0,0,-1,0,t],5:()=>[0,1,1,0,0,0],6:(e,t)=>[0,1,-1,0,t,0],7:(e,t)=>[0,-1,-1,0,t,e],8:e=>[0,-1,1,0,0,e]},fixImageOrientation=(e,t,a,i)=>{-1!==i&&e.transform(...transforms[i](t,a))},createPreviewImage=(e,t,a,i)=>{t=Math.round(t),a=Math.round(a),i>=5&&i<=8&&([t,a]=[a,t]);const r=document.createElement("canvas"),o=r.getContext("2d");return i>=5&&i<=8?(r.width=a,r.height=t):(r.width=t,r.height=a),o.save(),fixImageOrientation(o,t,a,i),o.drawImage(e,0,0,t,a),o.restore(),"close"in e&&e.close(),r},IMAGE_SCALE_SPRING_PROPS={type:"spring",stiffness:.5,damping:.45,mass:10},createImageView=e=>e.utils.createView({name:"image-preview",tag:"div",ignoreRect:!0,create:({root:e,props:t})=>{e.ref.clip=document.createElement("div"),e.element.appendChild(e.ref.clip)},write:e.utils.createRoute({DID_IMAGE_PREVIEW_LOAD:({root:e,props:t,action:a})=>{const{id:i}=t,r=e.query("GET_ITEM",{id:t.id}),o=(r.getMetadata("exif")||{}).orientation||-1;let{width:n,height:s}=a.data;o>=5&&o<=8&&([n,s]=[s,n]);const c=r.getMetadata("crop")||{rect:{x:0,y:0,width:1,height:1},aspectRatio:s/n},l=window.devicePixelRatio,p=e.query("GET_IMAGE_PREVIEW_HEIGHT"),d=e.query("GET_IMAGE_PREVIEW_MIN_HEIGHT"),E=e.query("GET_IMAGE_PREVIEW_MAX_HEIGHT"),I=e.rect.inner.width,h=s/n,m=I,_=I*h,g=null!==p?p:Math.max(d,Math.min(s,E)),w=g/h,y=createPreviewImage(a.data,w*l,g*l,o);let u=null!==p?p:Math.max(d,Math.min(I*c.aspectRatio,E)),T=u/c.aspectRatio;T>m&&(u=(T=m)*c.aspectRatio);const R=u/(_*c.rect.height);n=m*R,s=_*R;const v=-c.rect.x*m*R,M=-c.rect.y*_*R;e.ref.clip.style.cssText=`\n                    width: ${Math.round(T)}px;\n                    height: ${Math.round(u)}px;\n                `,y.style.cssText=`\n                    width: ${Math.round(n)}px;\n                    height: ${Math.round(s)}px;\n                    transform: translate(${Math.round(v)}px, ${Math.round(M)}px) rotateZ(0.00001deg);\n                `,e.ref.clip.appendChild(y),e.dispatch("DID_IMAGE_PREVIEW_DRAW",{id:i})}}),mixins:{styles:["scaleX","scaleY","opacity"],animations:{scaleX:IMAGE_SCALE_SPRING_PROPS,scaleY:IMAGE_SCALE_SPRING_PROPS,opacity:{type:"tween",duration:750}}}}),applyTemplate=(e,t)=>{t.width=e.width,t.height=e.height;t.getContext("2d").drawImage(e,0,0)},createImageOverlayView=e=>e.utils.createView({name:"image-preview-overlay",tag:"canvas",ignoreRect:!0,create:({root:e,props:t})=>{applyTemplate(t.template,e.element)},mixins:{styles:["opacity"],animations:{opacity:{type:"spring",mass:25}}}}),BitmapWorker=function(){self.onmessage=(t=>{e(t.data.message,e=>{self.postMessage({id:t.data.id,message:e},[e])})});const e=(e,t)=>{fetch(e.file).then(e=>e.blob()).then(e=>createImageBitmap(e)).then(e=>t(e))}},getImageSize=(e,t)=>{let a=new Image;a.onload=(()=>{const e=a.naturalWidth,i=a.naturalHeight;a=null,t(e,i)}),a.src=e},easeInOutSine=e=>-.5*(Math.cos(Math.PI*e)-1),addGradientSteps=(e,t,a=1,i=easeInOutSine,r=10,o=0)=>{const n=1-o,s=t.join(",");for(let t=0;t<=r;t++){const c=t/r,l=o+n*c;e.addColorStop(l,`rgba(${s}, ${i(c)*a})`)}},drawTemplate=(e,t,a,i,r)=>{e.width=t,e.height=a;const o=e.getContext("2d"),n=.5*t,s=o.createRadialGradient(n,a+110,a-100,n,a+110,a+100);addGradientSteps(s,i,r,void 0,8,.4),o.save(),o.translate(.5*-t,0),o.scale(2,1),o.fillStyle=s,o.fillRect(0,0,t,a),o.restore()},hasNavigator="undefined"!=typeof navigator,width=500,height=200,overlayTemplateShadow=hasNavigator&&document.createElement("canvas"),overlayTemplateError=hasNavigator&&document.createElement("canvas"),overlayTemplateSuccess=hasNavigator&&document.createElement("canvas");hasNavigator&&(drawTemplate(overlayTemplateShadow,500,200,[40,40,40],.85),drawTemplate(overlayTemplateError,500,200,[196,78,71],1),drawTemplate(overlayTemplateSuccess,500,200,[0,113,188],1));const createImageWrapperView=e=>{const t=createImageOverlayView(e),a=({root:e})=>{e.ref.overlayShadow.opacity=1,e.ref.overlayError.opacity=0,e.ref.overlaySuccess.opacity=0},i=({root:e})=>{e.ref.overlayShadow.opacity=.25,e.ref.overlayError.opacity=1};return e.utils.createView({name:"image-preview-wrapper",create:({root:a,props:i,dispatch:r})=>{const o=createImageView(e);a.ref.image=a.appendChildView(a.createChildView(o,{id:i.id,scaleX:1.25,scaleY:1.25,opacity:0})),a.ref.overlayShadow=a.appendChildView(a.createChildView(t,{template:overlayTemplateShadow,opacity:0})),a.ref.overlaySuccess=a.appendChildView(a.createChildView(t,{template:overlayTemplateSuccess,opacity:0})),a.ref.overlayError=a.appendChildView(a.createChildView(t,{template:overlayTemplateError,opacity:0}))},write:e.utils.createRoute({DID_IMAGE_PREVIEW_LOAD:({root:e,props:t})=>{e.ref.overlayShadow.opacity=1},DID_IMAGE_PREVIEW_DRAW:({root:e,props:t})=>{const{image:a}=e.ref;a.scaleX=1,a.scaleY=1,a.opacity=1},DID_IMAGE_PREVIEW_CONTAINER_CREATE:({root:t,props:a,action:i})=>{const{utils:r,views:o}=e,{createView:n,createWorker:s,loadImage:c}=r,{id:l}=a,p=t.query("GET_ITEM",l),d=URL.createObjectURL(p.file),E=(e,t,a,i)=>{c(d).then(I)},I=e=>{URL.revokeObjectURL(d),t.dispatch("DID_IMAGE_PREVIEW_LOAD",{id:l,data:e})};getImageSize(d,(e,a)=>{if(t.dispatch("DID_IMAGE_PREVIEW_CALCULATE_SIZE",{id:l,width:e,height:a}),"createImageBitmap"in window){const e=s(BitmapWorker);e.post({file:d},t=>{e.terminate(),t?I(t):E()})}else E()})},DID_THROW_ITEM_LOAD_ERROR:i,DID_THROW_ITEM_PROCESSING_ERROR:i,DID_THROW_ITEM_INVALID:i,DID_COMPLETE_ITEM_PROCESSING:({root:e})=>{e.ref.overlayShadow.opacity=.25,e.ref.overlaySuccess.opacity=1},DID_START_ITEM_PROCESSING:a,DID_REVERT_ITEM_PROCESSING:a})})};var plugin$1=e=>{const{addFilter:t,utils:a}=e,{Type:i,createRoute:r}=a,o=createImageWrapperView(e);return t("CREATE_VIEW",e=>{const{is:t,view:a,query:i}=e;if(!t("file")||!i("GET_ALLOW_IMAGE_PREVIEW"))return;a.registerWriter(r({DID_LOAD_ITEM:({root:e,props:t,actions:r})=>{const{id:n}=t,s=i("GET_ITEM",n);if(!s)return;const c=s.file;if(!isPreviewableImage(c))return;const l="createImageBitmap"in(window||{}),p=i("GET_IMAGE_PREVIEW_MAX_FILE_SIZE");!l&&p&&c.size>p||(e.ref.imagePreview=a.appendChildView(a.createChildView(o,{id:n})),e.dispatch("DID_IMAGE_PREVIEW_CONTAINER_CREATE",{id:n}))},DID_IMAGE_PREVIEW_CALCULATE_SIZE:({root:e,props:t,action:a})=>{const i=e.query("GET_ITEM",{id:t.id}),r=(i.getMetadata("exif")||{}).orientation||-1;let{width:o,height:n}=a;r>=5&&r<=8&&([o,n]=[n,o]);const s=i.getMetadata("crop")||{rect:{x:0,y:0,width:1,height:1},aspectRatio:n/o},c=e.query("GET_IMAGE_PREVIEW_HEIGHT"),l=e.query("GET_IMAGE_PREVIEW_MIN_HEIGHT"),p=e.query("GET_IMAGE_PREVIEW_MAX_HEIGHT");(o=(n=null!==c?c:Math.max(l,Math.min(n,p)))/s.aspectRatio)>e.rect.element.width&&(n=(o=e.rect.element.width)*s.aspectRatio),e.ref.imagePreview.element.style.cssText=`height:${Math.round(n)}px`}}))}),{options:{allowImagePreview:[!0,i.BOOLEAN],imagePreviewHeight:[null,i.INT],imagePreviewMinHeight:[44,i.INT],imagePreviewMaxHeight:[256,i.INT],imagePreviewMaxFileSize:[null,i.INT]}}};"undefined"!=typeof navigator&&document&&document.dispatchEvent(new CustomEvent("FilePond:pluginloaded",{detail:plugin$1}));export default plugin$1;
